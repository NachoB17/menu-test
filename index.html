<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu ‚Äî Maison Fleurie</title>
  <meta name="description" content="D√©couvrez le menu de Maison Fleurie ‚Äî Table des Mets, Cocktails & Vins √† Montpellier." />
  <meta name="theme-color" content="#0D1F13" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="fr_FR" />
  <meta property="og:title" content="Menu ‚Äî Maison Fleurie" />
  <meta property="og:description" content="Table des Mets ‚Ä¢ Cocktails ‚Ä¢ Vins √† Montpellier" />
  <meta property="og:image" content="https://raw.githubusercontent.com/maison-fleurie/Menu/main/logo.png" />
  <meta property="og:url" content="" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Fonts & perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Viaoda+Libre:wght@400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- PapaParse (SRI + defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --vert-fond:#0D1F13;--beige-logo:#ABA977;--blanc:#FFFFFF;--beige-clair:#F8F6F0;--vert-accent:#2A4A32;--or-accent:#D4C48A;--gris-texte:#4A5C4E;--ombre-douce:rgba(13,31,19,.1);--ombre-forte:rgba(13,31,19,.25);--gradient-warm:linear-gradient(135deg,#ABA977 0%,#D4C48A 50%,#E8D5A3 100%);--gradient-cool:linear-gradient(135deg,#0D1F13 0%,#2A4A32 50%,#4A6A4A 100%);--shadow-modern:0 8px 32px rgba(13,31,19,.12);--shadow-elevated:0 16px 64px rgba(13,31,19,.2);--radius-lg:24px;--radius-md:16px
    }

    *{box-sizing:border-box}
    html:focus-within{scroll-behavior:smooth}
    body{margin:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--gradient-warm);color:var(--vert-fond);min-height:100vh;line-height:1.6}

    @media (prefers-reduced-motion:no-preference){
      body{animation:backgroundBreath 8s ease-in-out infinite}
      @keyframes backgroundBreath{0%,100%{background:var(--gradient-warm)}50%{background:linear-gradient(135deg,#D4C48A 0%,#ABA977 50%,#E8D5A3 100%)}}
    }

    a,button{outline-offset:3px}

    header.header{position:relative;text-align:center;background:var(--gradient-cool);color:var(--beige-logo);padding:3rem 1rem 2rem;box-shadow:var(--shadow-elevated);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.1)}

    @media (prefers-reduced-motion:no-preference){
      .header-title{animation:titleGlow 4s ease-in-out infinite alternate}
      @keyframes titleGlow{0%{text-shadow:0 4px 8px rgba(0,0,0,.3)}100%{text-shadow:0 4px 8px rgba(0,0,0,.3),0 0 20px rgba(171,169,119,.4)}}
    }

    .header-title{font-family:'Viaoda Libre',serif;display:flex;align-items:center;justify-content:center;gap:2rem;margin:0;font-size:2.8rem;font-weight:400;letter-spacing:4px;line-height:1.2}
    .header-logo{height:3.5rem;width:3.5rem;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.4))}
    .header-subtitle{margin:1rem 0 0;font-size:1.2rem;font-weight:300;letter-spacing:1.5px;color:var(--or-accent)}

    .share-btn{position:absolute;right:16px;top:16px;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:var(--beige-logo);cursor:pointer;backdrop-filter:blur(6px)}
    .share-btn:hover{background:rgba(255,255,255,.15)}

    .search-container{margin:1.5rem auto 1rem;max-width:700px;padding:0 1rem}
    .search-row{display:flex;gap:.5rem}
    .search-box{flex:1;padding:1.1rem 1.2rem;font-size:1rem;border-radius:var(--radius-lg);border:2px solid transparent;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);box-shadow:var(--shadow-modern);color:var(--vert-fond)}
    .search-box:focus{border-color:var(--vert-fond);box-shadow:var(--shadow-elevated),0 0 0 4px rgba(13,31,19,.1);background:#fff}
    .clear-btn{border:2px solid var(--beige-logo);background:#fff;border-radius:var(--radius-lg);padding:.9rem 1rem;cursor:pointer}
    .search-results-info{font-size:1rem;color:var(--vert-fond);margin:1rem 0;font-weight:500;text-align:center;padding:.8rem 1.5rem;background:rgba(255,255,255,.9);border-radius:var(--radius-md);backdrop-filter:blur(15px);box-shadow:var(--shadow-modern)}

    main.container{max-width:900px;margin:1rem auto 3rem;background:rgba(255,255,255,.98);border-radius:var(--radius-lg);box-shadow:var(--shadow-elevated);overflow:hidden;border:1px solid rgba(13,31,19,.1);backdrop-filter:blur(20px)}

    .tab-btn{display:inline-flex;align-items:center;gap:.5rem}
    .tab-btn .ico{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px}
    .tab-btn .ico svg{width:18px;height:18px;display:block}

    nav.tab-nav{display:flex;flex-wrap:wrap;justify-content:center;background:linear-gradient(135deg,var(--beige-clair) 0%,rgba(255,255,255,.95) 100%);border-bottom:2px solid var(--vert-fond);gap:.6rem;padding:1rem;position:sticky;top:0;z-index:10;backdrop-filter:blur(15px)}
    .tab-btn{background:#fff;border:2px solid var(--beige-logo);padding:.9rem 1.2rem;font-size:1rem;cursor:pointer;font-weight:500;color:var(--vert-fond);border-radius:var(--radius-lg);position:relative;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .tab-btn[aria-selected="true"]{background:var(--gradient-cool);color:var(--beige-logo);border-color:var(--or-accent);box-shadow:0 8px 24px rgba(13,31,19,.2)}

    .tab-content{display:none;padding:2rem 1.5rem;background:#fff;min-height:420px}
    .tab-content.active{display:block}

    .menu-item{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;padding:1.1rem 1rem;border-bottom:1px solid rgba(13,31,19,.06);background:linear-gradient(135deg,rgba(248,246,240,.4) 0%,rgba(255,255,255,.8) 100%);border-radius:var(--radius-md)}
    .menu-item + .menu-item{margin-top:.7rem}
    .item-info{flex:1;min-width:0}
    .item-name{font-size:1.15rem;font-weight:600;color:var(--vert-fond);letter-spacing:.3px;line-height:1.3}
    .item-section{font-size:.8rem;color:var(--gris-texte);margin:.3rem 0 .5rem;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;opacity:.85}
    .item-description{font-size:.98rem;color:var(--gris-texte);font-style:italic;margin-top:.2rem}
    .item-price{font-size:1.05rem;color:var(--vert-fond);font-weight:700;background:var(--gradient-warm);border-radius:12px;padding:.5rem .75rem;min-width:84px;text-align:center}

    .section-title{font-family:'Viaoda Libre',serif;font-size:1.6rem;color:var(--vert-fond);margin:1.8rem 0 1rem;text-align:center;letter-spacing:1.5px;position:relative}
    .section-title::after{content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:80px;height:4px;background:var(--gradient-warm);border-radius:2px}
    .now-title{font-size:1.3rem;font-family:'Viaoda Libre',serif;color:var(--vert-accent);margin:1rem 0 1rem;text-align:center}

    .empty-state{text-align:center;color:var(--gris-texte);margin:2.2rem 0;padding:2rem 1.4rem;background:linear-gradient(135deg,rgba(248,246,240,.3) 0%,rgba(255,255,255,.5) 100%);border-radius:var(--radius-lg);border:1px solid rgba(13,31,19,.06)}
    .skeleton{display:block;height:16px;background:linear-gradient(90deg,#eee,#f7f7f7,#eee);border-radius:8px;animation:sheen 1.6s infinite}
    .skeleton.big{height:22px}
    @keyframes sheen{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}

    /* Wine Decision Tree */
    .wine-tree{padding:1.5rem 1rem}
    .wine-tree-header{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;justify-content:center}
    .wine-tree-title{font-family:'Viaoda Libre',serif;font-size:1.8rem;color:var(--vert-fond);margin:0;font-weight:400}
    .wine-icon{width:28px;height:28px;color:var(--beige-logo)}
    
    .progress-bar{display:flex;gap:.5rem;margin-bottom:1.2rem}
    .progress-step{flex:1;height:6px;background:rgba(171,169,119,.25);border-radius:3px;transition:all .3s}
    .progress-step.active{background:var(--gradient-warm)}
    
    .progress-info{text-align:center;color:var(--gris-texte);font-size:.85rem;margin-bottom:1.2rem;font-weight:400}
    
    .question-title{font-size:1.4rem;font-weight:600;color:var(--vert-fond);margin-bottom:1.2rem;text-align:center}
    
    .wine-options{display:flex;flex-direction:column;gap:.8rem}
    
    .wine-option{width:100%;padding:1rem 1.2rem;text-align:left;border:2px solid var(--beige-logo);border-radius:var(--radius-lg);background:#fff;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between;font-family:'Inter',sans-serif}
    
    .wine-option:hover{border-color:var(--vert-fond);background:rgba(248,246,240,.5);transform:translateX(4px)}
    
    .wine-option-content{flex:1}
    .wine-option-label{font-size:1rem;font-weight:500;color:var(--vert-fond);display:flex;align-items:center;gap:.5rem}
    .wine-option-desc{font-size:.85rem;color:var(--gris-texte);margin-top:.25rem;font-style:italic;font-weight:400}
    .wine-option-icon{font-size:1.4rem}
    
    .chevron-icon{width:18px;height:18px;color:var(--beige-logo);transition:transform .2s}
    .wine-option:hover .chevron-icon{transform:translateX(4px)}
    
    .wine-nav-btns{display:flex;gap:.8rem;margin-top:1.5rem;justify-content:center;flex-wrap:wrap}
    
    .wine-btn{padding:.85rem 1.5rem;border-radius:var(--radius-lg);font-size:.95rem;font-weight:500;cursor:pointer;transition:all .2s;border:none;display:flex;align-items:center;gap:.5rem;font-family:'Inter',sans-serif}
    
    .wine-btn-back{background:#fff;border:2px solid var(--beige-logo);color:var(--vert-fond)}
    .wine-btn-back:hover{background:rgba(248,246,240,.5)}
    
    .wine-btn-primary{background:var(--gradient-cool);color:var(--beige-logo);border:2px solid var(--or-accent)}
    .wine-btn-primary:hover{box-shadow:0 8px 24px rgba(13,31,19,.3)}
    
    .wine-btn-secondary{background:#fff;border:2px solid var(--vert-fond);color:var(--vert-fond)}
    .wine-btn-secondary:hover{background:var(--beige-clair)}
    
    .wine-recommendations{padding:1rem}
    .reco-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.5rem;justify-content:center}
    .reco-title{font-family:'Viaoda Libre',serif;font-size:1.8rem;color:var(--vert-fond);margin:0;font-weight:400}
    
    .wine-card{border:2px solid var(--beige-logo);border-radius:var(--radius-md);padding:1rem;margin-bottom:.8rem;background:linear-gradient(135deg,rgba(248,246,240,.3) 0%,rgba(255,255,255,.8) 100%);transition:all .3s}
    .wine-card:hover{border-color:var(--vert-fond);box-shadow:0 4px 16px rgba(13,31,19,.08);transform:translateY(-1px)}
    
    .wine-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:.7rem;gap:1rem}
    .wine-card-name{font-size:1.1rem;font-weight:600;color:var(--vert-fond);flex:1;line-height:1.3}
    .wine-card-price{font-size:1.1rem;font-weight:600;color:var(--vert-fond);background:#fff;border:2px solid var(--or-accent);padding:.4rem .8rem;border-radius:10px;white-space:nowrap}
    
    .wine-card-region{color:var(--gris-texte);font-size:.85rem;font-weight:500;margin-bottom:.4rem}
    .wine-card-grapes{color:var(--gris-texte);font-size:.8rem;margin-bottom:.6rem;font-weight:400}

    @media (max-width:768px){
      .header-title{font-size:2.2rem;gap:1.2rem}
      .header-logo{height:3rem;width:3rem}
      .menu-item{flex-direction:column}
      .item-price{align-self:flex-end}
      .wine-card-header{flex-direction:column;gap:.4rem}
      .wine-card-price{align-self:flex-start}
      .wine-nav-btns{flex-direction:column}
      .wine-btn{width:100%}
    }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <h1 class="header-title"><span>MAISON</span>
      <img src="https://raw.githubusercontent.com/maison-fleurie/Menu/main/logo.png" alt="Logo Maison Fleurie" class="header-logo" />
      <span>FLEURIE</span></h1>
    
    <button id="btnShare" class="share-btn" aria-label="Partager" title="Partager" tabindex="0">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.02-4.11A2.99 2.99 0 0 0 18 7.91c1.66 0 3-1.34 3-3S19.66 2 18 2s-3 1.34-3 3c0 .24.04.47.09.7l-7.02 4.11A2.99 2.99 0 0 0 6 9.91c-1.66 0-3 1.34-3 3s1.34 3 3 3c.82 0 1.56-.33 2.09-.87l7.02 4.11c-.05.21-.08.43-.08.66 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3Z"/></svg>
    </button>
    <p class="header-subtitle">Table des Mets ‚Ä¢ Cocktails ‚Ä¢ Vins</p>
  </header>

  <noscript>
    <style>.nojs{max-width:900px;margin:1rem auto;background:#fff;border:1px solid #c00;color:#111;padding:1rem;border-radius:12px}</style>
    <div class="nojs">‚ö†Ô∏è JavaScript est d√©sactiv√©. Activez‚Äële pour voir le menu interactif.</div>
  </noscript>

  <div class="search-container">
    <div class="search-row">
      <input id="searchBox" class="search-box" type="search" placeholder="Rechercher‚Ä¶ (ex: Vin, Bi√®re, Karaage poulet)" autocomplete="off" />
      <button id="clearSearch" class="clear-btn" aria-label="Effacer">‚úñ</button>
    </div>
    <div id="searchInfo" class="search-results-info" style="display:none"></div>
  </div>

  <main id="main" class="container" role="main">
    <nav class="tab-nav" role="tablist">
      <button id="tab-now" class="tab-btn" role="tab" aria-selected="true" data-tab="now"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l2 5 5 2-5 2-2 5-2-5-5-2 5-2z"/></svg></span><span>En ce moment</span></button>
      <button id="tab-deguster" class="tab-btn" role="tab" aria-selected="false" data-tab="deguster"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M7 3v10M11 3v10M5 7h8M16 4h3v9a3 3 0 0 1-3 3h-3"/></svg></span><span>D√©guster</span></button>
      <button id="tab-cocktails" class="tab-btn" role="tab" aria-selected="false" data-tab="cocktails"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M3 4h18l-7 7v7h-4v-7z"/></svg></span><span>Cocktails</span></button>
      <button id="tab-chaudes" class="tab-btn" role="tab" aria-selected="false" data-tab="chaudes"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 8h12a4 4 0 0 1 0 8H4z"/><path d="M7 4c0 2 2 2 2 4s-2 2-2 4"/></svg></span><span>Chaudes</span></button>
      <button id="tab-bieres" class="tab-btn" role="tab" aria-selected="false" data-tab="bieres"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M7 8h8v12H7z"/><path d="M15 10h2a3 3 0 0 1 0 6h-2"/></svg></span><span>Bi√®res</span></button>
      <button id="tab-softs" class="tab-btn" role="tab" aria-selected="false" data-tab="softs"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M7 7h10l-2 13H9z"/><path d="M9 11h8"/></svg></span><span>Softs</span></button>
      <button id="tab-vins" class="tab-btn" role="tab" aria-selected="false" data-tab="vins"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M7 3h10l-1 6a6 6 0 1 1-8 0z"/><path d="M12 15v6"/></svg></span><span>Vins</span></button>
    </nav>

    <section id="panel-now" class="tab-content active"></section>
    <section id="panel-deguster" class="tab-content"></section>
    <section id="panel-cocktails" class="tab-content"></section>
    <section id="panel-chaudes" class="tab-content"></section>
    <section id="panel-bieres" class="tab-content"></section>
    <section id="panel-softs" class="tab-content"></section>
    <section id="panel-vins" class="tab-content"></section>

    <div id="errorContainer" class="empty-state" style="display:none">
      <h3>Oups ! Impossible de charger le menu</h3>
      <p>V√©rifiez votre connexion et r√©essayez.</p>
      <button id="retryBtn">üîÑ R√©essayer</button>
    </div>
  </main>

  <script>
    if (typeof window !== 'undefined' && typeof window.invoke === 'undefined') {
      window.invoke = function(){ console.warn('[shim] window.invoke() non d√©fini'); };
    }

    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1lgd-rGS2kLCn0yPtGMc7RyMDue-YERmKOjNT3QKgJ3Y/export?format=csv&gid=0';
    const CACHE_KEY = 'mf-menu-v1'; const CACHE_AT = 'mf-menu-at'; const CACHE_TTL = 15*60*1000;

    let allMenuData = [], wineData = [], currentTab = 'now', isSearching = false, searchTimeout;
    let wineTreeStep = 0, wineTreeSelections = {}, showingWineList = false;

    const normalize = (s='') => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const tabIdFromOnglet = (s='') => normalize(s).replace(/\s/g,'');
    const formatPrice = (raw='') => {
      const str = String(raw).trim();
      if (!str || /‚Ç¨|\//.test(str)) return str;
      const num = Number(str.replace(',','.'));
      return (!isNaN(num) && Number.isInteger(num)) ? `${num}‚Ç¨` : str;
    };
    const byNameFR = (a,b) => (a?.Nom||'').localeCompare(b?.Nom||'','fr',{sensitivity:'base'});
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    const wineQuestions = [
      {
        id: 'color',
        question: 'Quelle couleur ?',
        options: [
          { value: 'blanc', label: 'Blanc', icon: 'ü§ç' },
          { value: 'rouge', label: 'Rouge', icon: '‚ù§Ô∏è' },
          { value: 'rose', label: 'Ros√©', icon: 'üå∏' }
        ]
      },
      {
        id: 'context',
        question: 'C\'est pour quel moment ?',
        options: [
          { value: 'apero', label: '√Ä l\'ap√©ritif' },
          { value: 'plat', label: 'Avec un plat' },
          { value: 'degustation', label: 'Pour d√©guster / d√©couvrir' }
        ]
      }
    ];

    const blancQuestions = [
      {
        id: 'style_blanc',
        question: 'Quel style en blanc ?',
        options: [
          { value: 'frais', label: 'Frais & Min√©ral', desc: 'Tension, vivacit√©, agrumes, salinit√©' },
          { value: 'gras', label: 'Rond & Aromatique', desc: 'Fruits blancs, texture caressante' },
          { value: 'atypique', label: 'Atypique / Mac√©ration', desc: 'Vin orange, peau, √©pices douces' }
        ]
      },
      {
        id: 'intensite_blanc',
        question: 'Plut√¥t l√©g√®ret√© ou structure ?',
        show: (sel) => sel.style_blanc === 'frais' || sel.style_blanc === 'gras',
        options: [
          { value: 'leger', label: 'L√©ger & D√©salt√©rant' },
          { value: 'structure', label: 'Avec de la Structure' }
        ]
      }
    ];

    const blancPlatQuestions = [
      {
        id: 'accord_blanc',
        question: 'Quel type de plat ?',
        show: (sel) => sel.context === 'plat' && sel.color === 'blanc',
        options: [
          { value: 'poisson', label: 'Poisson / Fruits de Mer' },
          { value: 'viande_blanche', label: 'Viande Blanche / Volaille' },
          { value: 'vegetarien', label: 'V√©g√©tarien / Fromage' }
        ]
      }
    ];

    const rougeQuestions = [
      {
        id: 'style_rouge',
        question: 'Quel style en rouge ?',
        options: [
          { value: 'souple', label: 'Fruits & Souplesse', desc: 'Croquant, facile √† boire' },
          { value: 'puissant', label: 'Puissant & Structur√©', desc: 'Tanins, √©pices, garrigue' },
          { value: 'nature', label: 'Nature / Biodynamie', desc: 'Authenticit√©, terroir vivant' }
        ]
      },
      {
        id: 'caractere',
        question: 'Quel caract√®re ?',
        show: (sel) => sel.style_rouge === 'souple' || sel.style_rouge === 'puissant',
        options: (sel) => {
          if (sel.style_rouge === 'souple') {
            return [
              { value: 'fruit', label: 'Fruits Rouges & Gourmand' },
              { value: 'elegance', label: '√âl√©gance & Finesse' }
            ];
          }
          return [
            { value: 'epice', label: '√âpices & Garrigue' },
            { value: 'terroir', label: 'Expression du Terroir' }
          ];
        }
      },
      {
        id: 'origine_nature',
        question: 'Quelle origine ?',
        show: (sel) => sel.style_rouge === 'nature',
        options: [
          { value: 'loire', label: 'Loire (Cabernet Franc, Chenin)' },
          { value: 'sud', label: 'Sud (Grenache, Syrah, Mourv√®dre)' }
        ]
      }
    ];

    const rougePlatQuestions = [
      {
        id: 'accord_rouge',
        question: 'Quel type de plat ?',
        show: (sel) => sel.context === 'plat' && sel.color === 'rouge',
        options: [
          { value: 'viande_rouge', label: 'Viande Rouge / Gibier' },
          { value: 'viande_blanche', label: 'Viande Blanche / Volaille' },
          { value: 'vegetarien', label: 'V√©g√©tarien / L√©gumes' }
        ]
      }
    ];

    const getWinesByPath = (selections) => {
      const { color, context, style_blanc, intensite_blanc, style_rouge, caractere, origine_nature, accord_blanc, accord_rouge } = selections;
      
      let filtered = wineData.filter(w => {
        const section = normalize(w.Section || '');
        if (color === 'rose' && !section.includes('rose')) return false;
        if (color === 'blanc' && !section.includes('blanc')) return false;
        if (color === 'rouge' && !section.includes('rouge')) return false;
        return true;
      });

      const contextKw = {
        apero: ['verre', 'ap√©ritif', 'l√©ger', 'frais', 'croquant'],
        plat: ['bouteille', 'gastronomique', 'structure', 'puissant'],
        degustation: ['bio', 'biodynamie', 'nature', 'terroir', 'vieilles vignes']
      };

      const blancStyleKw = {
        frais: ['frais', 'min√©ral', 'vif', 'salin', 'iod√©', 'tension', 'citron', 'agrumes'],
        gras: ['rond', 'gras', 'riche', 'aromatique', 'fruits blancs', 'floral'],
        atypique: ['orange', 'mac√©ration', 'nature', 'biodynamie', 'atypique']
      };

      const rougeStyleKw = {
        souple: ['souple', 'gamay', 'croquant', 'fruits rouges', 'gourmand', 'facile'],
        puissant: ['puissant', 'structure', 'tanins', 'syrah', 'mourv√®dre', '√©pices', 'garrigue'],
        nature: ['nature', 'bio', 'biodynamie', 'cabernet franc', 'grenache']
      };

      const accordBlancKw = {
        poisson: ['muscadet', 'iod√©', 'salin', 'fruits de mer', 'min√©ral'],
        viande_blanche: ['chardonnay', 'rond', 'gras', 'volaille'],
        vegetarien: ['frais', 'min√©ral', 'l√©ger', 'biodynamie']
      };

      const accordRougeKw = {
        viande_rouge: ['puissant', 'structure', 'tanins', 'syrah', 'crozes', 'terroir'],
        viande_blanche: ['souple', '√©l√©gant', 'gamay', 'pinot noir'],
        vegetarien: ['souple', 'fruits', 'l√©ger', 'bio']
      };

      filtered = filtered.map(wine => {
        const txt = normalize(`${wine.Section} ${wine.Nom} ${wine.Description}`);
        let score = 0;

        if (context && contextKw[context]) {
          score += contextKw[context].filter(k => txt.includes(k)).length * 2;
        }
        if (color === 'blanc' && style_blanc && blancStyleKw[style_blanc]) {
          score += blancStyleKw[style_blanc].filter(k => txt.includes(k)).length * 3;
        }
        if (color === 'rouge' && style_rouge && rougeStyleKw[style_rouge]) {
          score += rougeStyleKw[style_rouge].filter(k => txt.includes(k)).length * 3;
        }
        if (accord_blanc && accordBlancKw[accord_blanc]) {
          score += accordBlancKw[accord_blanc].filter(k => txt.includes(k)).length * 4;
        }
        if (accord_rouge && accordRougeKw[accord_rouge]) {
          score += accordRougeKw[accord_rouge].filter(k => txt.includes(k)).length * 4;
        }
        if (intensite_blanc === 'leger' && (txt.includes('verre') || txt.includes('l√©ger'))) score += 2;
        if (intensite_blanc === 'structure' && (txt.includes('bouteille') || txt.includes('structure'))) score += 2;
        if (caractere === 'fruit' && txt.includes('fruit')) score += 2;
        if (caractere === 'elegance' && (txt.includes('√©l√©gant') || txt.includes('finesse'))) score += 2;
        if (caractere === 'epice' && (txt.includes('√©pice') || txt.includes('garrigue'))) score += 2;
        if (caractere === 'terroir' && txt.includes('terroir')) score += 2;
        if (origine_nature === 'loire' && txt.includes('loire')) score += 3;
        if (origine_nature === 'sud' && (txt.includes('languedoc') || txt.includes('pic saint loup'))) score += 3;

        return { wine, score };
      });

      filtered.sort((a, b) => b.score - a.score);
      
      const verreWines = filtered.filter(w => {
        const sec = normalize(w.wine.Section || '');
        const desc = normalize(w.wine.Description || '');
        return sec.includes('verre') || desc.includes('12cl');
      });
      
      const bouteilleWines = filtered.filter(w => {
        const sec = normalize(w.wine.Section || '');
        const desc = normalize(w.wine.Description || '');
        return !sec.includes('verre') && !desc.includes('12cl');
      });
      
      const prioritized = [...verreWines, ...bouteilleWines];
      const recommendations = prioritized.filter(w => w.score > 0).slice(0, 6);
      
      if (recommendations.length === 0) {
        return prioritized.slice(0, 4).map(w => w.wine);
      }
      
      return recommendations.map(w => w.wine);
    };

    const getWineQuestions = () => {
      let questions = [...wineQuestions];
      if (wineTreeSelections.color === 'blanc') {
        questions = [...questions, ...blancQuestions];
        if (wineTreeSelections.context === 'plat') {
          questions = [...questions, ...blancPlatQuestions];
        }
      } else if (wineTreeSelections.color === 'rouge') {
        questions = [...questions, ...rougeQuestions];
        if (wineTreeSelections.context === 'plat') {
          questions = [...questions, ...rougePlatQuestions];
        }
      }
      return questions.filter(q => !q.show || q.show(wineTreeSelections));
    };

    const renderWineTree = () => {
      const panel = qs('#panel-vins');
      if (!panel) return;

      if (showingWineList) {
        renderWineList();
        return;
      }

      const questions = getWineQuestions();
      
      if (wineTreeStep >= questions.length) {
        renderWineRecommendations();
        return;
      }

      const currentQ = questions[wineTreeStep];
      const options = typeof currentQ.options === 'function' ? currentQ.options(wineTreeSelections) : currentQ.options;

      let html = `
        <div class="wine-tree">
          <div class="wine-tree-header">
            <svg class="wine-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 3h10l-1 6a6 6 0 1 1-8 0z"/><path d="M12 15v6"/>
            </svg>
            <h2 class="wine-tree-title">Guide de s√©lection des vins</h2>
          </div>
          
          <div class="progress-bar">
            ${questions.map((_, idx) => `<div class="progress-step ${idx <= wineTreeStep ? 'active' : ''}"></div>`).join('')}
          </div>
          
          <div class="progress-info">√âtape ${wineTreeStep + 1} sur ${questions.length}</div>
          
          <h3 class="question-title">${currentQ.question}</h3>
          
          <div class="wine-options">
            ${options.map(opt => `
              <button class="wine-option" data-value="${opt.value}">
                <div class="wine-option-content">
                  <div class="wine-option-label">
                    ${opt.icon ? `<span class="wine-option-icon">${opt.icon}</span>` : ''}
                    ${opt.label}
                  </div>
                  ${opt.desc ? `<div class="wine-option-desc">${opt.desc}</div>` : ''}
                </div>
                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            `).join('')}
          </div>
          
          <div class="wine-nav-btns">
            ${wineTreeStep > 0 ? `
              <button class="wine-btn wine-btn-back" id="wineBackBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
                Retour
              </button>
            ` : ''}
            <button class="wine-btn wine-btn-secondary" id="showAllWinesFromTreeBtn">
              üìã Voir tous les vins
            </button>
          </div>
        </div>
      `;

      panel.innerHTML = html;

      qsa('.wine-option').forEach(btn => {
        btn.addEventListener('click', () => {
          wineTreeSelections[currentQ.id] = btn.dataset.value;
          wineTreeStep++;
          renderWineTree();
        });
      });

      const backBtn = qs('#wineBackBtn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          const prevQ = questions[wineTreeStep - 1];
          delete wineTreeSelections[prevQ.id];
          wineTreeStep--;
          renderWineTree();
        });
      }
      
      const showAllBtn = qs('#showAllWinesFromTreeBtn');
      if (showAllBtn) {
        showAllBtn.addEventListener('click', () => {
          showingWineList = true;
          renderWineList();
        });
      }
    };

    const renderWineRecommendations = () => {
      const panel = qs('#panel-vins');
      if (!panel) return;

      const recommendations = getWinesByPath(wineTreeSelections);

      let html = `
        <div class="wine-recommendations">
          <div class="reco-header">
            <svg class="wine-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l2 5 5 2-5 2-2 5-2-5-5-2 5-2z"/>
            </svg>
            <h2 class="reco-title">Nos recommandations</h2>
          </div>

          ${recommendations.map(wine => `
            <div class="wine-card">
              <div class="wine-card-header">
                <div class="wine-card-name">${wine.Nom}</div>
                <div class="wine-card-price">${formatPrice(wine.Prix)}</div>
              </div>
              ${wine.Description ? `<div class="wine-card-region">${wine.Description.split(',')[0]}</div>` : ''}
              ${wine.Description && wine.Description.includes(',') ? `<div class="wine-card-grapes">${wine.Description.split(',').slice(1).join(',').trim()}</div>` : ''}
            </div>
          `).join('')}

          <div class="wine-nav-btns">
            <button class="wine-btn wine-btn-back" id="wineResetBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
              </svg>
              Nouvelle recherche
            </button>
            <button class="wine-btn wine-btn-secondary" id="showAllWinesBtn">
              üìã Voir tous les vins
            </button>
          </div>
        </div>
      `;

      panel.innerHTML = html;

      qs('#wineResetBtn').addEventListener('click', () => {
        wineTreeStep = 0;
        wineTreeSelections = {};
        showingWineList = false;
        renderWineTree();
      });

      qs('#showAllWinesBtn').addEventListener('click', () => {
        showingWineList = true;
        renderWineList();
      });
    };

    const renderWineList = () => {
      const panel = qs('#panel-vins');
      if (!panel) return;

      const groups = new Map();
      for (const wine of wineData) {
        const section = wine.Section || 'Autres';
        if (!groups.has(section)) groups.set(section, []);
        groups.get(section).push(wine);
      }

      let html = '<div style="padding: 1rem;">';
      
      for (const [section, wines] of groups) {
        html += `<h2 class="section-title">${section}</h2>`;
        wines.sort(byNameFR).forEach(wine => {
          html += `
            <div class="menu-item">
              <div class="item-info">
                <div class="item-name">${wine.Nom}</div>
                ${wine.Description ? `<div class="item-description">${wine.Description}</div>` : ''}
              </div>
              <div class="item-price">${formatPrice(wine.Prix)}</div>
            </div>
          `;
        });
      }

      html += `
        <div class="wine-nav-btns" style="margin-top: 2rem;">
          <button class="wine-btn wine-btn-primary" id="backToTreeBtn">
            üç∑ Retour au guide de s√©lection
          </button>
        </div>
      </div>`;

      panel.innerHTML = html;

      qs('#backToTreeBtn').addEventListener('click', () => {
        showingWineList = false;
        wineTreeStep = 0;
        wineTreeSelections = {};
        renderWineTree();
      });
    };

    const panels = {
      now: qs('#panel-now'), deguster: qs('#panel-deguster'), cocktails: qs('#panel-cocktails'),
      chaudes: qs('#panel-chaudes'), bieres: qs('#panel-bieres'), softs: qs('#panel-softs'), vins: qs('#panel-vins')
    };

    const showSkeleton = (el) => {
      el.innerHTML = `
        <div class="now-title">Chargement‚Ä¶</div>
        <div class="menu-item"><span class="skeleton big" style="width:60%"></span><span class="skeleton" style="width:90px"></span></div>
        <div class="menu-item"><span class="skeleton big" style="width:40%"></span><span class="skeleton" style="width:90px"></span></div>`;
    };

    const createItemHTML = (item) => {
      const section = item.Section ? `<div class="item-section">${item.Section}</div>` : '';
      const desc = item.Description ? `<div class="item-description">${item.Description}</div>` : '';
      return `
        <div class="menu-item">
          <div class="item-info">
            <div class="item-name">${item.Nom || ''}</div>
            ${section}${desc}
          </div>
          <div class="item-price">${formatPrice(item.Prix || '')}</div>
        </div>`;
    };

    const renderNow = () => {
      const el = panels.now; if (!el) return;
      let html = `<div class="now-title">√Ä l'affiche en ce moment</div>`;
      const nowItems = allMenuData.filter(i => normalize(i['En ce moment']) === 'oui');
      if (!nowItems.length){
        el.innerHTML = `<div class="empty-state"><h3>Aucune nouveaut√©</h3></div>`;
        return;
      }
      const groups = new Map();
      for (const it of nowItems){
        const key = it.Section || 'Autres';
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      for (const [section, items] of groups){
        html += `<h2 class="section-title">${section}</h2>`;
        items.sort(byNameFR).forEach(it => { html += createItemHTML(it); });
      }
      el.innerHTML = html;
    };

    const renderTab = (tabName) => {
      if (tabName === 'now') return renderNow();
      if (tabName === 'vins') return renderWineTree();
      
      const el = panels[tabName]; if (!el) return;
      const tabItems = allMenuData.filter(i => tabIdFromOnglet(i.Onglet) === tabName);
      if (!tabItems.length){
        el.innerHTML = `<div class="empty-state"><h3>Section vide</h3></div>`;
        return;
      }
      const groups = new Map();
      for (const it of tabItems){
        const key = it.Section || 'Autres';
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      let html = '';
      for (const [section, items] of groups){
        html += `<h2 class="section-title">${section}</h2>`;
        items.sort(byNameFR).forEach(it => { html += createItemHTML(it); });
      }
      el.innerHTML = html;
    };

    const renderAll = () => {
      for (const key of Object.keys(panels)) renderTab(key);
    };

    const setActiveTab = (tabName) => {
      currentTab = tabName;
      qsa('.tab-btn').forEach(btn => {
        const active = btn.dataset.tab === tabName;
        btn.setAttribute('aria-selected', active ? 'true' : 'false');
        btn.tabIndex = active ? 0 : -1;
      });
      qsa('.tab-content').forEach(p => p.classList.remove('active'));
      qs(`#panel-${tabName}`)?.classList.add('active');
      if (!isSearching) renderTab(tabName);
    };

    const focusNextTab = (dir) => {
      const tabs = qsa('.tab-btn');
      const idx = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
      const next = (idx + dir + tabs.length) % tabs.length;
      tabs[next].focus();
      setActiveTab(tabs[next].dataset.tab);
    };

    function ensurePapa(){
      return new Promise((resolve, reject) => {
        if (window.Papa?.parse) return resolve();
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
        s.onload = () => window.Papa?.parse ? resolve() : reject();
        s.onerror = reject;
        document.head.appendChild(s);
        setTimeout(() => { if (!window.Papa?.parse) reject(); }, 5000);
      });
    }

    const parseAndSet = (rows=[]) => {
      const sanitize = (r) => { const o={}; for (const k in r){ const nk=(k||'').trim(); let v=r[k]; if (typeof v==='string') v=v.trim(); o[nk]=v; } return o; };
      const cleaned = rows.map(sanitize);
      allMenuData = cleaned.filter(i => normalize(i.Actif) === 'oui' || normalize(i['Actif '])==='oui');
      wineData = allMenuData.filter(i => normalize(i.Onglet).includes('vin'));
      renderAll();
    };

    const loadFromCacheIfFresh = () => {
      try{
        const at = Number(localStorage.getItem(CACHE_AT)||0);
        if (Date.now() - at < CACHE_TTL){
          const cached = JSON.parse(localStorage.getItem(CACHE_KEY)||'[]');
          if (Array.isArray(cached) && cached.length){ parseAndSet(cached); return true; }
        }
      }catch{}
      return false;
    };

    const saveCache = (rows) => {
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
        localStorage.setItem(CACHE_AT, String(Date.now()));
      }catch{}
    };

    const showError = () => { qs('#errorContainer').style.display = 'block'; };
    const hideError = () => { qs('#errorContainer').style.display = 'none'; };

    const fetchCSVAndRender = async () => {
      Object.values(panels).forEach(p => p && showSkeleton(p));
      if (loadFromCacheIfFresh()) return;

      let attempt = 0;
      while (attempt < 3){
        try{
          await new Promise((resolve, reject) => {
            Papa.parse(CSV_URL, {
              download: true,
              header: true,
              complete: (res) => {
                if (res.errors?.length){ reject(res.errors); return; }
                hideError();
                saveCache(res.data);
                parseAndSet(res.data);
                resolve();
              },
              error: reject
            });
          });
          return;
        }catch(e){
          attempt++;
          if (attempt >= 3){ showError(); break; }
          await new Promise(r => setTimeout(r, 400 * Math.pow(2, attempt)));
        }
      }
    };

    let lastQuery = '', lastSearchResults = [];

    const performSearch = (query) => {
      isSearching = true; lastQuery = query;
      const q = normalize(query);
      const results = allMenuData.filter(i =>
        normalize(i.Nom).includes(q) || normalize(i.Description).includes(q) || normalize(i.Section).includes(q)
      );
      lastSearchResults = results;
      const info = qs('#searchInfo');
      info.style.display = 'block';
      info.textContent = `${results.length} r√©sultat(s) pour "${query}"`;
    };

    const clearSearch = () => {
      isSearching = false;
      qs('#searchBox').value = '';
      qs('#searchInfo').style.display = 'none';
      renderTab(currentTab);
    };

    const init = () => {
      qsa('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          setActiveTab(btn.dataset.tab);
        });
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowRight') { e.preventDefault(); focusNextTab(+1); }
          if (e.key === 'ArrowLeft')  { e.preventDefault(); focusNextTab(-1); }
        });
      });

      qs('#searchBox').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (!query){ clearSearch(); return; }
        searchTimeout = setTimeout(() => performSearch(query), 250);
      });
      qs('#clearSearch').addEventListener('click', clearSearch);
      qs('#retryBtn').addEventListener('click', () => ensurePapa().then(fetchCSVAndRender).catch(showError));

      const share = qs('#btnShare');
      if (share){
        share.addEventListener('click', async () => {
          const url = location.href;
          if (navigator.share){ try{ await navigator.share({title:document.title,url}); }catch(e){} }
          else { try{ await navigator.clipboard.writeText(url); }catch(e){} }
        });
      }

      ensurePapa().then(fetchCSVAndRender).catch(showError);
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
